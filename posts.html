<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts - Y Social Media</title>
    <link rel="stylesheet" href="style.css?v=2.0">
</head>

<body>

    <!-- HEADER / NAVBAR -->
    <header>
        <div class="logo">Y</div>

        <nav>
            <a href="index.html">Home</a>
            <a href="posts.html">Posts</a>
            <a href="#">Clubs</a>
            <a href="profile.html">Profile</a>
            <a href="settings.html">Settings</a>
        </nav>

        <div style="flex: 1; max-width: 300px; margin: 0 20px;">
            <div style="position: relative;">
                <input type="text" id="searchBar" placeholder="Search users, posts..." 
                    style="width: 100%; padding: 10px 15px; border: none; border-radius: 20px; background: rgba(255,255,255,0.2); color: var(--header-text); font-size: 14px;"
                    onfocus="showSearchResults()" onkeyup="performSearch(event)" />
                <div id="searchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 8px; margin-top: 5px; display: none; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: var(--shadow);"></div>
            </div>
        </div>

        <div>
            <button class="login-btn" id="navLoginBtn">Login</button>
            <button class="theme-btn" id="themeToggle">Dark Mode</button>
        </div>
    </header>

    <!-- POSTS SECTION -->
    <section class="hero">
        <h1>All Posts</h1>
        <button class="cta" id="add_post">Add Post</button>

        <div style="display: none" id="add_post_form">
            <h2>Create a Post</h2>
            <input type="text" id="postTitle" placeholder="Title..." /><br><br>
            <textarea id="postContent" placeholder="Write your post..."></textarea><br>
            <button id="submitPost" class="cta">Submit</button>
        </div>
    </section>

    <!-- FEED SECTION -->
    <section class="feed">
        <h2>Recent Posts</h2>
    </section>

    <!-- ðŸ”¥ FIREBASE INTEGRATION -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAZkklblmr2WM6KJ2wI58GZA-KbekFf9Q8",
            authDomain: "cmms-y-404fe.firebaseapp.com",
            projectId: "cmms-y-404fe",
            storageBucket: "cmms-y-404fe.firebasestorage.app",
            messagingSenderId: "763819042330",
            appId: "1:763819042330:web:e6ab7d7e9146e430bad3a3",
            measurementId: "G-8QV4820GSH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Check auth state and update login button
        onAuthStateChanged(auth, (user) => {
            const navLoginBtn = document.getElementById("navLoginBtn");
            if (user) {
                navLoginBtn.textContent = "Logout";
                navLoginBtn.onclick = async () => {
                    try {
                        await signOut(auth);
                        window.location.href = "posts.html";
                    } catch (error) {
                        console.error("Error logging out:", error);
                    }
                };
            } else {
                navLoginBtn.textContent = "Login";
                navLoginBtn.onclick = () => {
                    window.location.href = "login.html";
                };
            }
        });

        // Function to load posts from Firestore
        async function loadPosts() {
            try {
                const postsCollection = collection(db, "posts");
                const q = query(postsCollection, orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                const feedSection = document.querySelector(".feed");
                const existingPosts = feedSection.querySelectorAll(".post:not(:first-child)");
                existingPosts.forEach(post => post.remove());

                querySnapshot.forEach((doc) => {
                    const postData = doc.data();
                    const postDiv = document.createElement("div");
                    postDiv.className = "post";
                    const authorHandle = postData.author?.split('@')[0] || 'Anonymous';
                    const avatarInitial = authorHandle.charAt(0).toUpperCase();
                    postDiv.innerHTML = `
                        <div class="post-header">
                            <div class="post-author-info">
                                <div style="position: relative; display: inline-block;">
                                    <p class="post-author-name" style="cursor: pointer;" onclick="toggleProfileCard(event, '${postData.author}', '${authorHandle}')">${authorHandle}</p>
                                    <p class="post-author-handle">@${postData.author || 'user'}</p>
                                    <div id="profile-card-${doc.id}" class="profile-card" style="display: none; position: absolute; left: 0; top: 100%; z-index: 1000; width: 220px; margin-top: -8px;">
                                        <div class="profile-card-avatar">${avatarInitial}</div>
                                        <div class="profile-card-info">
                                            <p class="profile-card-name">${authorHandle}</p>
                                            <p class="profile-card-handle">@${postData.author}</p>
                                        </div>
                                        <button class="profile-card-follow" onclick="toggleFollow('${postData.author}', this)">Follow</button>
                                    </div>
                                </div>
                            </div>
                            <p class="post-timestamp">${new Date(postData.timestamp).toLocaleDateString()}</p>
                        </div>
                        <h3>${postData.title}</h3>
                        <p>${postData.content}</p>
                        <div class="post-meta">${new Date(postData.timestamp).toLocaleTimeString()}</div>
                        <div class="post-actions">
                            <button class="reply-toggle-btn" onclick="toggleReplies('${doc.id}')">ðŸ’¬ Reply</button>
                        </div>
                        <div id="replies-${doc.id}" class="replies-section" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--card-border);">
                            <div id="replies-list-${doc.id}" class="replies-list"></div>
                            <div class="reply-form" style="margin-top: 15px;">
                                <input type="text" class="reply-input" id="reply-input-${doc.id}" placeholder="Write a reply..." />
                                <button class="reply-submit-btn" onclick="submitReply('${doc.id}')">Reply</button>
                            </div>
                        </div>
                    `;
                    feedSection.appendChild(postDiv);
                });
            } catch (error) {
                console.error("Error loading posts:", error);
            }
        }

        // Function to submit a post
        async function submitPost(title, content) {
            const user = auth.currentUser;
            if (!user) {
                alert("You must be logged in to create a post.");
                window.location.href = "login.html";
                return;
            }

            try {
                await addDoc(collection(db, "posts"), {
                    title: title,
                    content: content,
                    author: user.email,
                    timestamp: new Date().getTime()
                });
                document.getElementById("postTitle").value = "";
                document.getElementById("postContent").value = "";
                document.getElementById("add_post_form").style.display = "none";
                alert("Post created successfully!");
                loadPosts();
            } catch (error) {
                console.error("Error adding post:", error);
                alert(`Failed to submit post: ${error.message}`);
            }
        }

        // Make functions globally accessible
        window.loadPosts = loadPosts;
        window.submitPost = submitPost;

        // Global functions for replies
        window.toggleReplies = async function(postId) {
            const repliesSection = document.getElementById(`replies-${postId}`);
            if (repliesSection.style.display === "none") {
                repliesSection.style.display = "block";
                await loadReplies(postId);
            } else {
                repliesSection.style.display = "none";
            }
        };

        async function loadReplies(postId) {
            try {
                const repliesList = document.getElementById(`replies-list-${postId}`);
                repliesList.innerHTML = "<p style='color: var(--text-light); font-size: 14px;'>Loading replies...</p>";
                
                const repliesCollection = collection(db, `posts/${postId}/replies`);
                const q = query(repliesCollection, orderBy("timestamp", "asc"));
                const querySnapshot = await getDocs(q);
                
                repliesList.innerHTML = "";
                
                if (querySnapshot.empty) {
                    repliesList.innerHTML = "<p style='color: var(--text-light); font-size: 14px;'>No replies yet. Be the first to reply!</p>";
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const replyData = doc.data();
                    const replyDiv = document.createElement("div");
                    replyDiv.className = "reply";
                    replyDiv.innerHTML = `
                        <p style="margin: 0 0 5px 0; font-weight: 600; color: var(--accent); font-size: 13px;">${replyData.author}</p>
                        <p style="margin: 0 0 8px 0; color: var(--text); font-size: 14px;">${replyData.content}</p>
                        <small style="color: var(--text-light);">${new Date(replyData.timestamp).toLocaleString()}</small>
                    `;
                    repliesList.appendChild(replyDiv);
                });
            } catch (error) {
                console.error("Error loading replies:", error);
                document.getElementById(`replies-list-${postId}`).innerHTML = "<p style='color: red;'>Error loading replies</p>";
            }
        }

        window.submitReply = async function(postId) {
            const replyInput = document.getElementById(`reply-input-${postId}`);
            const replyContent = replyInput.value.trim();

            if (!replyContent) {
                alert("Please write a reply");
                return;
            }

            if (!auth.currentUser) {
                alert("You must be logged in to reply");
                window.location.href = "login.html";
                return;
            }

            try {
                await addDoc(collection(db, `posts/${postId}/replies`), {
                    author: auth.currentUser.email,
                    content: replyContent,
                    timestamp: new Date().getTime()
                });
                replyInput.value = "";
                await loadReplies(postId);
            } catch (error) {
                console.error("Error submitting reply:", error);
                alert(`Failed to submit reply: ${error.message}`);
            }
        };

        // Profile card functions
        window.toggleProfileCard = function(event, email, name) {
            event.stopPropagation();
            const postId = event.target.closest('.post').querySelector('[id^="profile-card-"]').id.replace('profile-card-', '');
            const profileCard = document.getElementById('profile-card-' + postId);
            
            // Close other profile cards
            document.querySelectorAll('.profile-card').forEach(card => {
                if (card !== profileCard) card.style.display = 'none';
            });
            
            profileCard.style.display = profileCard.style.display === 'none' ? 'block' : 'none';
        };

        window.toggleFollow = function(email, button) {
            let following = JSON.parse(localStorage.getItem('following') || '[]');
            
            if (following.includes(email)) {
                following = following.filter(e => e !== email);
                button.textContent = 'Follow';
                button.classList.remove('following');
            } else {
                following.push(email);
                button.textContent = 'Following';
                button.classList.add('following');
            }
            
            localStorage.setItem('following', JSON.stringify(following));
        };

        // Close profile cards on click outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.profile-card').forEach(card => {
                card.style.display = 'none';
            });
        });

        // Search functionality
        window.performSearch = async function(event) {
            const query = event.target.value.trim();
            const searchResults = document.getElementById('searchResults');

            if (!query) {
                searchResults.style.display = 'none';
                return;
            }

            try {
                // Search users
                const usersCollection = collection(db, "users");
                const q = query(usersCollection);
                const userSnapshot = await getDocs(q);
                
                // Search posts
                const postsCollection = collection(db, "posts");
                const q2 = query(postsCollection);
                const postSnapshot = await getDocs(q2);

                let html = '';

                // Filter and display matching users
                const matchingUsers = [];
                userSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.displayName?.toLowerCase().includes(query.toLowerCase()) || 
                        userData.email?.toLowerCase().includes(query.toLowerCase())) {
                        matchingUsers.push({type: 'user', id: doc.id, data: userData});
                    }
                });

                // Filter and display matching posts
                const matchingPosts = [];
                postSnapshot.forEach(doc => {
                    const postData = doc.data();
                    if (postData.title?.toLowerCase().includes(query.toLowerCase()) || 
                        postData.content?.toLowerCase().includes(query.toLowerCase())) {
                        matchingPosts.push({type: 'post', id: doc.id, data: postData});
                    }
                });

                // Display results
                if (matchingUsers.length > 0) {
                    html += '<div style="padding: 10px; border-bottom: 1px solid var(--card-border); font-weight: 700; color: var(--text-light); font-size: 12px;">USERS</div>';
                    matchingUsers.slice(0, 5).forEach(user => {
                        const displayName = user.data.displayName || user.data.email.split('@')[0];
                        const avatar = displayName.charAt(0).toUpperCase();
                        html += `
                            <div style="padding: 10px; border-bottom: 1px solid var(--card-border); display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="navigateToProfile('${user.data.email}')">
                                <div style="width: 30px; height: 30px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; color: #1E29EB; font-weight: 700;">${avatar}</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 14px; color: var(--text);">${displayName}</div>
                                    <div style="font-size: 12px; color: var(--text-light);">@${user.data.email}</div>
                                </div>
                            </div>
                        `;
                    });
                }

                if (matchingPosts.length > 0) {
                    html += '<div style="padding: 10px; border-bottom: 1px solid var(--card-border); font-weight: 700; color: var(--text-light); font-size: 12px;">POSTS</div>';
                    matchingPosts.slice(0, 5).forEach(post => {
                        html += `
                            <div style="padding: 10px; border-bottom: 1px solid var(--card-border); cursor: pointer;" onclick="scrollToPost('${post.id}')">
                                <div style="font-weight: 600; font-size: 14px; color: var(--text);">${post.data.title}</div>
                                <div style="font-size: 12px; color: var(--text-light); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${post.data.content}</div>
                            </div>
                        `;
                    });
                }

                if (matchingUsers.length === 0 && matchingPosts.length === 0) {
                    html = '<div style="padding: 15px; text-align: center; color: var(--text-light);">No results found</div>';
                }

                searchResults.innerHTML = html;
                searchResults.style.display = 'block';
            } catch (error) {
                console.error("Search error:", error);
            }
        };

        window.showSearchResults = function() {
            const searchBar = document.getElementById('searchBar');
            if (searchBar.value.trim()) {
                document.getElementById('searchResults').style.display = 'block';
            }
        };

        // Close search when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.id !== 'searchBar') {
                document.getElementById('searchResults').style.display = 'none';
            }
        });

        // Load posts on page load
        loadPosts();
    </script>

    <!-- THEME SWITCH SCRIPT -->
    <script>
        const themeBtn = document.getElementById("themeToggle");

        // Function to apply theme
        function applyTheme(themeName) {
            // Remove all theme classes
            document.body.classList.remove("theme-twitter", "theme-catppuccin", "theme-retro", "theme-classic");
            
            // Apply new theme
            if (themeName && themeName !== "twitter") {
                document.body.classList.add(`theme-${themeName}`);
            }
        }

        // Load saved theme and dark mode preference
        const savedTheme = localStorage.getItem("theme-style") || "twitter";
        const isDarkMode = localStorage.getItem("theme") === "dark";
        
        applyTheme(savedTheme);
        
        if (isDarkMode) {
            document.body.classList.add("dark-theme");
            themeBtn.textContent = "Light Mode";
        }

        themeBtn.onclick = () => {
            document.body.classList.toggle("dark-theme");

            const isDark = document.body.classList.contains("dark-theme");

            themeBtn.textContent = isDark ? "Light Mode" : "Dark Mode";

            // Save choice
            localStorage.setItem("theme", isDark ? "dark" : "light");
        };
    </script>

    <!-- Add & Submit buttons -->
    <script>
        const $ = document.getElementById.bind(document);

        $('add_post').onclick = () => $('add_post_form').style.display = 'block';
        $('submitPost').onclick = () => {
            const title = $('postTitle').value.trim();
            const content = $('postContent').value.trim();
            
            if (title && content) {
                window.submitPost(title, content);
            } else {
                alert("Please fill in both title and content.");
            }
        };
    </script>

</body>
</html>
